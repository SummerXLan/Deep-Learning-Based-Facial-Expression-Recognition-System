<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史记录 - 表情识别系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .container {
            max-width: 1200px;  /* 增加容器最大宽度 */
            width: 95%;        /* 设置容器宽度为95%，两边留白 */
            margin: 0 auto;    /* 居中显示 */
        }

        .history-list {
            width: 100%;
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);  /* 固定4列 */
            gap: 1.5rem;       /* 增加间距 */
            padding: 0.5rem;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 8px;  /* 增加圆角 */
            padding: 1rem;      /* 增加内边距 */
            text-align: left;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);  /* 增强阴影效果 */
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .history-item img {
            width: 100%;
            height: 200px;     /* 增加图片高度 */
            object-fit: cover;
            border-radius: 6px;
            margin-top: 0.5rem;
        }
        
        .history-item .time {
            color: #6c757d;
            font-size: 0.9rem;  /* 略微增加时间字体大小 */
            margin-bottom: 0.5rem;
        }
        
        .history-empty {
            color: #6c757d;
            text-align: center;
            padding: 2rem;
            grid-column: 1 / -1;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90vh;
            margin: auto;
            display: block;
            position: relative;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;  /* 增加圆角 */
        }

        .close {
            position: absolute;
            top: -40px;        /* 调整关闭按钮位置 */
            right: -40px;
            color: white;
            font-size: 28px;   /* 增加关闭按钮大小 */
            cursor: pointer;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-time {
            position: absolute;
            bottom: -30px;
            left: 0;
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .history-list {
                grid-template-columns: repeat(3, 1fr);  /* 中等屏幕3列 */
            }
        }

        @media (max-width: 768px) {
            .history-list {
                grid-template-columns: repeat(2, 1fr);  /* 平板2列 */
            }
            .history-item img {
                height: 180px;
            }
        }

        @media (max-width: 480px) {
            .history-list {
                grid-template-columns: 1fr;  /* 手机单列 */
            }
            .history-item img {
                height: 220px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/upload" class="navbar-brand">表情识别系统</a>
        <div class="navbar-links">
            <a href="/upload">上传图片</a>
            <a href="/history">历史记录</a>
            <a href="/logout">退出登录</a>
        </div>
    </nav>
    
    <div class="container">
        <h1>历史记录</h1>
        <div id="history-actions" style="margin-bottom:1rem;display:flex;align-items:center;gap:1rem;">
            <button type="button" class="btn" id="startDeleteBtn" style="background:#e74c3c;">删除</button>
            <button type="button" class="btn" id="cancelDeleteBtn" style="display:none;background:#aaa;">取消</button>
            <input type="checkbox" id="selectAll" style="display:none;" onclick="toggleSelectAll(this)"> <label for="selectAll" id="selectAllLabel" style="margin:0;cursor:pointer;display:none;">全选/取消全选</label>
            <button type="button" class="btn" id="confirmDeleteBtn" style="display:none;background:#e74c3c;">确认删除</button>
        </div>
        <form id="deleteForm" method="POST" action="/history/delete">
            <div class="history-list">
                {% if records %}
                    {% for record in records %}
                        <div class="history-item" onclick="openModal('{{ url_for('static', filename='output_images/' + record.output_image) }}', '{{ record.created_at.strftime('%Y-%m-%d %H:%M:%S') }}')">
                            <input type="checkbox" name="delete_ids" value="{{ record.input_image }}" class="delete-checkbox" style="margin-bottom:0.5rem;cursor:pointer;display:none;" onclick="event.stopPropagation();">
                            <div class="time">{{ record.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                            <img src="{{ url_for('static', filename='output_images/' + record.output_image) }}" alt="处理结果">
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="history-empty">
                        暂无历史记录
                    </div>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- 模态框 -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <img id="modalImage" src="" alt="放大图片">
            <div id="modalTime" class="modal-time"></div>
        </div>
    </div>

    <script>
        function openModal(imageSrc, time) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalTime = document.getElementById('modalTime');
            
            modal.style.display = 'flex';
            modalImg.src = imageSrc;
            modalTime.textContent = time;
            
            // 阻止事件冒泡
            event.stopPropagation();
        }

        function closeModal(e) {
            if (e) {
                e.stopPropagation(); // 阻止事件冒泡
            }
            document.getElementById('imageModal').style.display = 'none';
        }

        // 点击模态框内容时不关闭
        document.querySelector('.modal-content').addEventListener('click', function(event) {
            event.stopPropagation();
        });

        // 点击关闭按钮关闭模态框
        document.querySelector('.close').addEventListener('click', function(event) {
            closeModal(event);
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        function toggleSelectAll(checkbox) {
            const boxes = document.querySelectorAll('.delete-checkbox');
            boxes.forEach(box => { box.checked = checkbox.checked; });
        }
        // 删除模式交互
        const startDeleteBtn = document.getElementById('startDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const selectAll = document.getElementById('selectAll');
        const selectAllLabel = document.getElementById('selectAllLabel');
        const checkboxes = document.querySelectorAll('.delete-checkbox');
        const deleteForm = document.getElementById('deleteForm');
        startDeleteBtn.onclick = function() {
            checkboxes.forEach(cb => cb.style.display = 'inline-block');
            selectAll.style.display = 'inline-block';
            selectAllLabel.style.display = 'inline-block';
            confirmDeleteBtn.style.display = 'inline-block';
            cancelDeleteBtn.style.display = 'inline-block';
            startDeleteBtn.style.display = 'none';
        };
        cancelDeleteBtn.onclick = function() {
            checkboxes.forEach(cb => { cb.checked = false; cb.style.display = 'none'; });
            selectAll.checked = false;
            selectAll.style.display = 'none';
            selectAllLabel.style.display = 'none';
            confirmDeleteBtn.style.display = 'none';
            cancelDeleteBtn.style.display = 'none';
            startDeleteBtn.style.display = 'inline-block';
        };
        confirmDeleteBtn.onclick = function() {
            if (Array.from(checkboxes).some(cb => cb.checked)) {
                if (confirm('确定要删除选中的记录吗？')) {
                    deleteForm.submit();
                }
            } else {
                alert('请选择要删除的记录');
            }
        };
    </script>
</body>
</html> 